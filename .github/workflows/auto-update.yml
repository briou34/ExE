name: Auto Update and Format

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write # Allow git push

jobs:
  format-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Needed if committing back

    - name: Set up Python and uv
      uses: astral-sh/setup-uv@v3 # Official uv setup action

    - name: Format Python files
      run: uvx ruff format .

    - name: Format YAML files
      run: uvx yamlfix --exclude .github/workflows/*.yml .

    - name: Compute new hive map
      run: uv run hive/hive.py --save

    - name: Compute new bear hunt damages graphs
      run: |
        uv run bear_hunt/analysis.py --graph --save --bear 1
        uv run bear_hunt/analysis.py --graph --save --bear 2

    - name: Update READMEs via cog
      run: |
        uvx --from cogapp cog -Pr README.md
        uvx --from cogapp --with pyyaml cog -Pr hive/README.md
        uvx --from cogapp --with pyyaml cog -Pr bear_hunt/README.md

    - name: Check files before formatting
      run: git status && git diff --stat

    - name: Format Markdown files
      run: uvx mdformat --number .

    - name: Check files after formatting
      run: git status && git diff --stat

    - name: Commit and push changes (if any)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        if ! git diff --cached --quiet; then
          git commit -m "chore: auto updates"
          git push
        else
          echo "No changes to commit"
        fi
